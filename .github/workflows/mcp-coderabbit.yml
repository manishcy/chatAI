name: PR + MCP Analysis

on:
  pull_request:
    types: [opened, reopened, synchronize]
    branches:
      - dev
      - master

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  run-mcp-analysis:
    runs-on: ubuntu-latest

    steps:
      # Checkout PR code
      - name: Checkout code
        uses: actions/checkout@v3

      # Install Node dependencies (if package.json exists)
      - name: Install dependencies
        run: |
          if [ -f "package.json" ]; then
            npm install
          fi

      # Run MCP server and save output
      - name: Run MCP Analysis
        id: mcp
        run: |
          echo "Running MCP..."
          OUTPUT=$(node mcp-server.js)
          echo "$OUTPUT" > mcp-output.json

          # Escape MCP output for GitHub comment
          esc_output="${OUTPUT//'%'/'%25'}"
          esc_output="${esc_output//$'\n'/'%0A'}"
          esc_output="${esc_output//$'\r'/'%0D'}"

          echo "result=$esc_output" >> $GITHUB_OUTPUT

      # Comment the MCP output on PR
      - name: Comment on Pull Request
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.pull_request.number;
            const output = `${{ steps.mcp.outputs.result }}`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `### ðŸ¤– MCP Analysis Output\n\n\`\`\`json\n${output}\n\`\`\``
            });

