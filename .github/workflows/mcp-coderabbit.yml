name: PR + MCP Analysis

on:
  pull_request:
    types: [opened, reopened, synchronize]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  run-mcp-analysis:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          if [ -f "package.json" ]; then
            npm install
          fi

      - name: Run MCP Analysis
        run: |
          echo "Running MCP..."
          node mcp-server.js > mcp-output.json

      - name: Comment on Pull Request (with MCP + CodeRabbit)
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');

            const prNumber = context.payload.pull_request.number;

            // 1Ô∏è‚É£ Read MCP output
            const mcpOutput = fs.readFileSync('mcp-output.json', 'utf8');

            // 2Ô∏è‚É£ Fetch ALL existing PR comments (including CodeRabbit)
            const comments = await github.paginate(
              github.rest.issues.listComments,
              {
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
              }
            );

            // Filter comments created by CodeRabbit bot
            const coderabbitComments = comments
              .filter(c => c.user && c.user.login.includes("coderabbit"))
              .map(c => `- ${c.body}`)
              .join("\n\n");

            // 3Ô∏è‚É£ Build final comment body
            const finalComment = `
### ü§ñ MCP Analysis Output
\`\`\`json
${mcpOutput}
\`\`\`

---

### üê∞ CodeRabbit Suggestions & Reviews  
${coderabbitComments || "_No CodeRabbit suggestions found_"}
`;

            // 4Ô∏è‚É£ Post the combined comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: finalComment
            });
